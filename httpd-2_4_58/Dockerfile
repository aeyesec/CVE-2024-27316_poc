FROM httpd:2.4.58

# Enable the mod_ssl module
RUN sed -i \
    -e 's/^#\(Include .*httpd-ssl.conf\)/\1/' \
    -e 's/^#\(LoadModule .*mod_ssl.so\)/\1/' \
    /usr/local/apache2/conf/httpd.conf

# Enable the mod_socache_shmcb module
RUN sed -i '/^#\(LoadModule .*mod_socache_shmcb.so\)/s/^#//g' /usr/local/apache2/conf/httpd.conf

# Enable the mod_http2 module
RUN sed -i '/^#\(LoadModule .*mod_http2.so\)/s/^#//g' /usr/local/apache2/conf/httpd.conf

# Enable HTTP/2 over HTTP (h2c)
RUN echo "Protocols h2c http/1.1" >> /usr/local/apache2/conf/httpd.conf

# Enable HTTP/2 over HTTPS
RUN echo "Protocols h2 http/1.1" >> /usr/local/apache2/conf/extra/httpd-ssl.conf

# Generate a self-signed SSL certificate
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /usr/local/apache2/conf/server.key -out /usr/local/apache2/conf/server.crt -subj "/C=JP/ST=Tokyo/L=Chiyoda-ku/O=Example Inc./OU=Web/CN=localhost"

# Expose ports 80 and 443
EXPOSE 80 443